// Variables used by Scriptable.
// These must be at the very top of the file. Do not edit.
// icon-color: deep-green; icon-glyph: mosque;
function t(t,e,n,i){return new(n||(n=Promise))((function(o,r){function a(t){try{d(i.next(t))}catch(t){r(t)}}function s(t){try{d(i.throw(t))}catch(t){r(t)}}function d(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}d((i=i.apply(t,e||[])).next())}))}function e(e){return t(this,void 0,void 0,(function*(){let t=FileManager.iCloud();if(t.fileExists(e)){t.isFileDownloaded(e)||(yield t.downloadFileFromiCloud(e));const n=t.readString(e);return JSON.parse(n)}return[]}))}function n(t,e,n){const i=function(t,e){let n=t.includes("?");for(const i in e)if(e.hasOwnProperty(i)){const o=e[i];null!=o&&(t+=(n?"&":"?")+encodeURIComponent(i)+"="+encodeURIComponent(o.toString()),n=!0)}return t}(`${t}${o(e)}`,n);return encodeURI(i)}function i(t){const[e,n,i]=t.split("-"),o=new Date(Number(i),Number(n)-1,Number(e));return o.setHours(0,0,0,0),o}function o(t){const e=t||new Date;return new Date(e).toLocaleString(void 0,{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,"-")}function r(t,e={hour:"numeric",minute:"numeric",hour12:!0}){return t.toLocaleTimeString(void 0,e).toUpperCase()}function a(e){return t(this,void 0,void 0,(function*(){const t=new Request(e);return yield t.loadJSON()}))}function s(n,o,r){return t(this,void 0,void 0,(function*(){const t=r,a=yield e(n),s=[];(function(t){const e=[];return t.forEach((t=>{e.some((e=>JSON.stringify(e)===JSON.stringify(t)))||e.push(t)})),e})(a).filter((({date:{gregorian:{date:t}}})=>{const e=new Date;e.setHours(0,0,0,0);const n=new Date(e);n.setDate(e.getDate()+o);const r=i(t)>=e,a=i(t)<=n;return r&&a})),t.forEach((t=>{if(!1===s.some((e=>JSON.stringify(e)===JSON.stringify(t)))){const e=s.findIndex((({date:{gregorian:{date:e}}})=>t.date.gregorian.date===e));e>=0&&(s[e]=t),-1===e&&s.push(t)}})),s.sort(((t,e)=>{const n=new Date(t.date.gregorian.date),i=new Date(e.date.gregorian.date);return n<i?-1:n>i?1:0})),function(t,e){let n=FileManager.iCloud(),i=JSON.stringify(e,null,2);n.writeString(t,i)}(n,s)}))}function d(t,e,n){const i=new Date,a=new Color("#888888"),s=new ListWidget;s.setPadding(16,20,16,20),s.spacing=4;const d=s.addStack();d.layoutVertically(),d.centerAlignContent(),d.spacing=4,t.forEach((t=>{const{prayer:n,time:i,status:o}=t,a=e.find((t=>t.name.toLowerCase()===n.toLowerCase()));if(a){const{abbreviation:t}=a,e=r(i);!function(t,e,n,i,o){const r=14;let a,s=new Font("AvenirNext-Regular",12);"future"===i.state&&(a=new Color("#888888"));i.next&&(s=new Font("AvenirNext-Bold",r));const d=t.addStack();d.spacing=o,d.centerAlignContent();const c=d.addText(e);c.font=s,c.lineLimit=1,d.addSpacer(void 0);const u=d.addText(n);u.font=s,u.lineLimit=1,a&&(c.textColor=a,u.textColor=a)}(d,t,e,o,4)}}));const u=s.addStack();u.layoutVertically();const l=c(u,`${n} metres`);l.font=new Font("AvenirNext-Regular",10),l.textColor=a;const f=c(u,`${o(i)} ${r(i)}`);f.font=new Font("AvenirNext-Regular",10),f.textColor=a,s.presentSmall()}function c(t,e){const n=t.addStack();n.addSpacer();const i=n.addText(e);return i.lineLimit=1,n.addSpacer(),i}"function"==typeof SuppressedError&&SuppressedError;const u={widget:{settings:{file:"Prayer Time",directory:"Prayer Time",size:"small",offline:3},display:{prayerTimes:[{name:"fajr",display:"🌄",abbreviation:"FAJ"},{name:"dhuhr",display:"🕛",abbreviation:"DHU"},{name:"asr",display:"🌞",abbreviation:"ASR"},{name:"maghrib",display:"🌆",abbreviation:"MAG"},{name:"isha",display:"🌙",abbreviation:"ISH"},{name:"imsak",display:"⭐",abbreviation:"IMS"}]}},api:{endpoint:"https://api.aladhan.com/v1/timings/",location:{latitude:0,longitude:0}}};t(void 0,void 0,void 0,(function*(){try{yield function(){return t(this,void 0,void 0,(function*(){const{widget:{settings:{directory:o,file:r,offline:c},display:{prayerTimes:l}},api:{location:f}}=u,g=1e3,m=5,p=function(t,e){const n=`${t}.json`,i=e,o=FileManager.iCloud(),r=o.joinPath(o.documentsDirectory(),i);return o.fileExists(r)||o.createDirectory(r),o.joinPath(r,n)}(r,o);let y=0;if(yield function(){return t(this,void 0,void 0,(function*(){const t=new Request("https://www.google.com");t.method="HEAD",t.timeoutInterval=.25;try{return!!(yield t.load())}catch(t){return!1}}))}()){const{latitude:o,longitude:r}=yield function(e){return t(this,void 0,void 0,(function*(){return yield Location.current()}))}();u.api.location.latitude=o,u.api.location.longitude=r;const d=new Date,l=function(t,e){const n=t.filter((({date:{gregorian:{date:t}}})=>{const n=e||new Date;n.setHours(0,0,0,0);const o=i(t);return n.toDateString()===o.toDateString()}));if(n[0])return n[0]}(yield e(p),d);if(l){const{meta:{latitude:t,longitude:e}}=l,n=function(t,e){const n=t=>t*(Math.PI/180),i=n(e.latitude-t.latitude),o=n(e.longitude-t.longitude),r=Math.sin(i/2)*Math.sin(i/2)+Math.cos(n(t.latitude))*Math.cos(n(e.latitude))*Math.sin(o/2)*Math.sin(o/2);return 2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))*6371*1e3}(f,{latitude:t,longitude:e});y=Math.round(100*(n+Number.EPSILON))/100}if(f&&(!l||y>g)){const e=yield function(e){return t(this,void 0,void 0,(function*(){const{api:{endpoint:t,method:i,location:{latitude:o,longitude:r}},widget:{settings:{offline:s}}}=e,d=[];for(let e=0;e<s;e++){const s=new Date;s.setDate(s.getDate()+e);const c=n(t,s,{latitude:o,longitude:r,method:i}),u=(yield a(c)).data;d.push(u)}return d}))}(u);yield s(p,c,e)}}const h=yield e(p);h&&function(t,e,n,i){const o=new Date,r=new Date(new Date(o).setHours(0,0,0,0)),a=new Date(r.getTime()+864e5-1),s=e.map((t=>t.name.toUpperCase())),c=t.map((t=>function(t){const{timings:e,date:{gregorian:n}}=t,i=n.date.split("-"),o=`${i[2]}-${i[1]}-${i[0]}`;return Object.entries(e).map((([t,e])=>{const n=e.split(":");return{prayer:t,time:new Date(`${o}T${n[0]}:${n[1]}:00`)}}))}(t))).flat().filter((t=>s.includes(t.prayer.toUpperCase()))).filter((t=>t.time>o)).sort(((t,e)=>t.time.getTime()-e.time.getTime())).slice(0,i),u=c.findIndex((t=>t.time>o));d(c.map(((t,e)=>{let n="unknown",i=!1;return n=t.time<o?"past":t.time>o&&t.time<=a?"today":"future",e===u&&(i=!0),{prayer:t.prayer,time:t.time,status:{state:n,next:i}}})),e,n)}(h,l,y,m)}))}()}catch(t){console.error(t)}}));
